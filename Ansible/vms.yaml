---
- name: Prepare Kubernetes nodes
  hosts: all
  become: yes
  tasks:
    # Обновляем систему
    - name: Update and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes

    # Ставим зависимости
    - name: Install dependencies
      apt:
        name:
          - curl
          - wget
          - git
          - net-tools
          - chrony
          - apt-transport-https
          - ca-certificates
        state: present

    # Отключаем SWAP 
    - name: Disable swap
      systemd:
        name: swap.target
        state: stopped
        enabled: false
        masked: yes
 
    # 4. СТАТИЧЕСКИЕ IP ЧЕРЕЗ /etc/network/interfaces (работает везде)
    - name: Configure static IP - Master
      copy:
        content: |
          # The loopback network interface
          auto lo
          iface lo inet loopback

          # Master node
          auto enp0s3  # your interface
          iface enp0s3 inet static
              address #IP-master
              netmask 255.255.255.0
              gateway # IP роутера
              dns-nameservers 8.8.8.8 8.8.4.4
        dest: /etc/network/interfaces
      when: inventory_hostname == 'master'

    - name: Configure static IP - Worker1
      copy:
        content: |
          # The loopback network interface
          auto lo
          iface lo inet loopback

          # Worker node
          auto enp0s3
          iface enp0s3 inet static
              address #IP-worker
              netmask 255.255.255.0
              dns-nameservers 8.8.8.8 8.8.4.4
        dest: /etc/network/interfaces
      when: inventory_hostname == 'worker1'

    # 5. Перезагружаем сеть (универсальный способ)
    - name: Restart networking
      shell: |
        ifdown {{ ansible_default_ipv4.interface | default('ens3') }} || true
        ifup {{ ansible_default_ipv4.interface | default('ens3') }}
      ignore_errors: yes

    # 6. Проверяем сеть
    - name: Test internet connectivity
      shell: ping -c 3 8.8.8.8
      register: ping_result

    - name: Show ping result
      debug:
        var: ping_result.stdout_lines

    # 7. Дополнительно для K8s
    - name: Increase vm.max_map_count
      sysctl:
        name: vm.max_map_count
        value: "262144"
        state: present
        reload: yes

    - name: Load required kernel modules
      shell: |
        cat <<EOF | tee /etc/modules-load.d/k8s.conf
        overlay
        br_netfilter
        EOF
        modprobe overlay
        modprobe br_netfilter

    - name: Sysctl settings for Kubernetes
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        dest: /etc/sysctl.d/k8s.conf
      notify: sysctl reload

  handlers:
    - name: sysctl reload
      command: sysctl --system